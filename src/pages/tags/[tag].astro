---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("posts");
  const tags = Array.from(new Set(posts.flatMap((post) => post.data.tags || [])));

  return tags.map((tag) => ({
    params: { tag },
  }));
}

const { tag } = Astro.params;
const decodedTag = tag ? decodeURIComponent(tag) : "";
const posts = await getCollection("posts");

const filteredPosts = posts
  .filter((post) => (post.data.tags || []).includes(decodedTag))
  .sort(
    (a, b) =>
      new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
  );

const tagCounts = posts.reduce((counts, post) => {
  (post.data.tags || []).forEach((postTag) => {
    counts.set(postTag, (counts.get(postTag) || 0) + 1);
  });
  return counts;
}, new Map<string, number>());

const sortedTagsWithCount = Array.from(tagCounts.entries()).sort((a, b) =>
  a[0].localeCompare(b[0], "fr")
);
---

<Layout title={`Tag: ${decodedTag}`}>
  <div class="home-layout">
    <div class="home-main">
      <h2 style="font-family: var(--font-heading); font-size: 2.5rem; color: var(--color-primary); margin-bottom: 1rem;">
        Tag : {decodedTag}
      </h2>

      {filteredPosts.length === 0 ? (
        <p>Aucun article pour ce tag.</p>
      ) : (
        <div class="posts-list">
          {filteredPosts.map((post) => (
            <article class="post-card">
              {post.data.coverImage && (
                <img
                  src={post.data.coverImage}
                  alt={post.data.coverImageAlt || post.data.title}
                  class="post-card-image"
                />
              )}
              <div class="post-card-content">
                <h4>
                  <a href={`/posts/${post.slug}`}>{post.data.title}</a>
                </h4>
                <div class="post-card-meta">
                  <time datetime={post.data.date}>
                    {new Date(post.data.date).toLocaleDateString("fr-FR", {
                      year: "numeric",
                      month: "long",
                      day: "numeric",
                    })}
                  </time>
                  {post.data.difficulty && <span> • {post.data.difficulty}</span>}
                </div>
                <p>{post.data.description}</p>
              </div>
            </article>
          ))}
        </div>
      )}
    </div>

    <aside class="home-sidebar" aria-label="Informations complementaires">
      <section class="home-sidebar-box">
        <h3>Tous les tags</h3>
        {sortedTagsWithCount.length === 0 ? (
          <p>Aucun tag pour le moment.</p>
        ) : (
          <ul class="home-tag-list">
            {sortedTagsWithCount.map(([postTag, count]) => (
              <li>
                <a href={`/tags/${encodeURIComponent(postTag)}`}>{postTag}</a>{" "}
                <span>({count})</span>
              </li>
            ))}
          </ul>
        )}
      </section>

      <section class="home-sidebar-box"></section>
    </aside>
  </div>
</Layout>
