---
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";

const posts = await getCollection("posts");
const sortedPosts = posts.sort(
    (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
);
const latestPosts = sortedPosts.slice(0, 3);
const tagCounts = posts.reduce((counts, post) => {
    (post.data.tags || []).forEach((tag) => {
        counts.set(tag, (counts.get(tag) || 0) + 1);
    });
    return counts;
}, new Map<string, number>());
const sortedTags = Array.from(tagCounts.entries()).sort((a, b) =>
    a[0].localeCompare(b[0], "fr"),
);
const difficultyCounts = posts.reduce((counts, post) => {
    const difficulty = post.data.difficulty;
    if (difficulty) {
        counts.set(difficulty, (counts.get(difficulty) || 0) + 1);
    }
    return counts;
}, new Map<string, number>());
const sortedDifficulties = Array.from(difficultyCounts.entries()).sort((a, b) =>
    a[0].localeCompare(b[0], "fr"),
);
---

<Layout title="Accueil">
    <div class="home-layout">
        <div class="home-main">
            <section class="hero">
                <h2>Bienvenue sur mon blog de Latte Art</h2>
                <p>
                    Barista passionné, je partage avec vous mes techniques et
                    astuces pour réaliser de beaux latte art chez vous, avec
                    votre propre machine. Débutant ou amateur
                    éclairé, vous trouverez ici des conseils pratiques pour
                    progresser à votre rythme.
                </p>
            </section>

            <section class="posts-grid">
                <h3>Derniers articles</h3>
                <div class="posts-list">
                    {
                        latestPosts.map((post) => (
                            <article class="post-card">
                                {post.data.coverImage && (
                                    <img
                                        src={post.data.coverImage}
                                        alt={post.data.coverImageAlt || post.data.title}
                                        class="post-card-image"
                                    />
                                )}
                                <div class="post-card-content">
                                    <h4>
                                        <a href={`/posts/${post.slug}`}>
                                            {post.data.title}
                                        </a>
                                    </h4>
                                    <div class="post-card-meta">
                                        <time datetime={post.data.date}>
                                            {new Date(
                                                post.data.date,
                                            ).toLocaleDateString("fr-FR", {
                                                year: "numeric",
                                                month: "long",
                                                day: "numeric",
                                            })}
                                        </time>
                                        {post.data.difficulty && (
                                            <span> • {post.data.difficulty}</span>
                                        )}
                                    </div>
                                    <p>{post.data.description}</p>
                                </div>
                            </article>
                        ))
                    }
                </div>
            </section>
        </div>

        <aside class="home-sidebar" aria-label="Informations complémentaires">
            <section class="home-sidebar-box">
                <h3>Tous les tags</h3>
                {sortedTags.length === 0 ? (
                    <p>Aucun tag pour le moment.</p>
                ) : (
                    <ul class="home-tag-list">
                        {sortedTags.map(([tag, count]) => (
                            <li>
                                <a href={`/tags/${encodeURIComponent(tag)}`}>
                                    {tag}
                                </a>{" "}
                                <span>({count})</span>
                            </li>
                        ))}
                    </ul>
                )}
            </section>

            <section class="home-sidebar-box">
                <h3>Tous les niveaux</h3>
                {sortedDifficulties.length === 0 ? (
                    <p>Aucun niveau pour le moment.</p>
                ) : (
                    <ul class="home-tag-list">
                        {sortedDifficulties.map(([difficulty, count]) => (
                            <li>
                                <a href={`/difficulty/${encodeURIComponent(difficulty)}`}>
                                    {difficulty}
                                </a>{" "}
                                <span>({count})</span>
                            </li>
                        ))}
                    </ul>
                )}
            </section>
        </aside>
    </div>
</Layout>
